#!/usr/bin/env ruby
require "rubygems"
require "opengl"
require 'ruby-prof'
require 'optparse'

# parse options
$options = {
	:profile => false,
	:scene => "default"
}
OptionParser.new do |opts|
	opts.banner = "Usage: #{$0} --profile --scene <name> [host[:port[:localport]]]"
	opts.on("-p", "--profile", "Profile the scene"){|v| $options[:profile] = v }
	opts.on("-s", "--scene SCENE", "Select a scene to load"){|v| $options[:scene] = v }
end.parse!

# defines
ROOT=File.dirname($0)
DATA="#{ROOT}/data"
LIB="#{ROOT}/lib"
SCENES="#{ROOT}/scenes"
PROFILE="#{ROOT}/profile.txt"

# append load paths
$: << LIB

# load libs
# make sure your libs require their own dependencies
Dir["#{LIB}/*"].sort.each{|file| require file }

# profile the scene
# dump profile to file
if $options[:profile]
	RubyProf.start
	at_exit {
	#Kernel.trap('EXIT') {
		result = RubyProf.stop
		printer = RubyProf::FlatPrinter.new(result)
		file = File.new PROFILE, 'w'
		printer.print(file, 0)
		file.close
		puts "profile saved to #{PROFILE}"
	}
end

# load scene
require "#{SCENES}/#{$options[:scene]}"
